name: Move Assigned Issue to In Progress

on:
  issues:
    types: [assigned]

jobs:
  move:
    name: Move Issue to In Progress
    runs-on: ubuntu-latest
    steps:
      - name: Move issue to In Progress
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECTS_MOVE }}
          ISSUE_ID: ${{ github.event.issue.node_id }}
        run: |
          # Получаем ID проекта
          PROJECT_ID=$(gh api graphql -f query='
            query {
              repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                projectsV2(first: 1) {
                  nodes {
                    id
                  }
                }
              }
            }
          ' --jq '.data.repository.projectsV2.nodes[0].id')
          
          echo "Project ID: $PROJECT_ID"
          
          # Получаем ID колонки "In Progress"
          IN_PROGRESS_FIELD_ID=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f projectId=$PROJECT_ID --jq '.data.node.fields.nodes[] | select(.name=="Status") | .id')
          
          echo "Status field ID: $IN_PROGRESS_FIELD_ID"
          
          # Получаем ID опции "In Progress"
          IN_PROGRESS_OPTION_ID=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f projectId=$PROJECT_ID --jq '.data.node.fields.nodes[] | select(.name=="Status") | .options[] | select(.name=="In Progress") | .id')
          
          echo "In Progress option ID: $IN_PROGRESS_OPTION_ID"
          
          # Находим ID элемента проекта для данной задачи
          ITEM_ID=$(gh api graphql -f query='
            query($projectId: ID!, $issueId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          id
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f projectId=$PROJECT_ID -f issueId=$ISSUE_ID --jq ".data.node.items.nodes[] | select(.content.id==\"$ISSUE_ID\") | .id")
          
          echo "Item ID: $ITEM_ID"
          
          # Обновляем статус задачи на "In Progress"
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { 
                    singleSelectOptionId: $optionId
                  }
                }
              ) {
                projectV2Item {
                  id
                }
              }
            }
          ' -f projectId=$PROJECT_ID -f itemId=$ITEM_ID -f fieldId=$IN_PROGRESS_FIELD_ID -f optionId=$IN_PROGRESS_OPTION_ID
